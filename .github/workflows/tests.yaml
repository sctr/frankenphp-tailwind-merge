name: Tests

on:
  push:
    branches: [main]
  pull_request:

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.26']

    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - name: Run unit tests
        run: go test -race -v -count=1 ./pkg/...

  integration-tests:
    name: Integration Tests (PHP ${{ matrix.php-version }})
    runs-on: ubuntu-latest
    needs: unit-tests
    strategy:
      matrix:
        php-version: ['8.4', '8.5']

    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.26'

      - name: Install PHP ${{ matrix.php-version }} with embed SAPI
        run: |
          sudo add-apt-repository ppa:ondrej/php -y
          sudo apt-get update
          sudo apt-get install -y php${{ matrix.php-version }}-dev php${{ matrix.php-version }}-cli libphp${{ matrix.php-version }}-embed libsodium-dev libargon2-dev
          # FrankenPHP links with -lphp but the ondrej PPA installs the
          # embed library with a versioned name. Use dpkg to find the
          # actual .so, then create a libphp.so symlink the linker can find.
          dpkg -L libphp${{ matrix.php-version }}-embed
          PHP_LIB=$(dpkg -L libphp${{ matrix.php-version }}-embed | grep -E '\.so' | head -1)
          if [ -z "$PHP_LIB" ]; then
            echo "No .so in package manifest; searching filesystem..."
            PHP_LIB=$(find /usr -name 'libphp*' \( -name '*.so' -o -name '*.so.*' \) ! -name 'libphp.so' 2>/dev/null | head -1)
          fi
          [ -n "$PHP_LIB" ] || { echo "FATAL: PHP embed library not found"; exit 1; }
          echo "PHP embed library: $PHP_LIB"
          sudo ln -sf "$PHP_LIB" /usr/lib/x86_64-linux-gnu/libphp.so
          sudo ldconfig

      - name: Build FrankenPHP with tailwind_merge
        run: |
          go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest
          CGO_ENABLED=1 \
          CGO_CFLAGS="$(php-config --includes)" \
          CGO_LDFLAGS="$(php-config --ldflags) $(php-config --libs)" \
          XCADDY_GO_BUILD_FLAGS="-tags=nobadger,nomysql,nopgx,nowatcher,nobrotli" \
          xcaddy build \
            --output frankenphp \
            --with github.com/sctr/frankenphp-tailwind-merge=.

      - name: Run integration test
        run: |
          cd testdata
          ../frankenphp php-cli index.php | tee output.txt
          grep -q "extension_loaded: true" output.txt
          grep -q "shorthand: p-3" output.txt
          grep -q 'hero: hover:bg-dark-red p-3 bg-\[#B91C1C\]' output.txt
